---
title: "nigeria_lsms"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
library(sf)
library(readr)
library(dplyr)
library(tidyr)
library(dummies)
library(haven)
```


```{r}
# auxiliary function for handling sums of NA vectors
# handles NA by returning NA if all are NA
sumNA <- function(x) {
  if (all(is.na(x))) {
    return(NA)
  } else {
    return(sum(x, na.rm=TRUE))
  }
}

# take a vector of inputs: if at least 1 input is 1, then return 1 else 0.
# handles NA by returning NA if all are NA
indicator <- function(x) {
  if (all(is.na(x))) {
    return(NA)
  } else if (sum(x, na.rm=TRUE) > 0) {
    return(1)
  } else {
    return(0)
  }
}
```

# Plan

1) spatial_join lsms fert, lsms pest, and gahi prevalence data with level2 shapefiles
2) apply transformations to fert + pest to aggregate % households per level2 region
3) combine gahi prevalence with lsms data

# Remarks
Quantity data for fertilizer was NOT found (units were missing)
Wave 2 Nigeria pesticide data was missing. 
Quantity data for pesticide + herbicide can be found, but it is provided in 3 variables: amount purchased, amount leftover, and amount free.

# Shapefiles 

from GADM. data is at the 2nd administrative level (Local Govt Areas)

```{r}
nga_sf <- readRDS('../shapefiles/nga/GADM/gadm36_NGA_2_sf.rds')
st_crs(nga_sf)
```

# Geovars (location)

```{r}
loc1 <- read_csv("../lsms_data/nigeria/w1/NGA_HouseholdGeovariables_Y1.csv")
loc1

loc2 <- read_csv("../lsms_data/nigeria/w2/NGA_HouseholdGeovars_Y2.csv")
loc2 

loc3 <- read_csv("../lsms_data/nigeria/w3/nga_householdgeovars_y3.csv")
loc3

```

```{r}
loc1_f <- loc1 %>% select(hhid, longitude=lon_dd_mod, latitude = lat_dd_mod)
loc1_mappings <- unique(loc1_f)

loc2_f <- loc2 %>% select(hhid, longitude=lon_dd_mod, latitude = lat_dd_mod)
loc2_mappings <- unique(loc2_f)

loc3_f <- loc3 %>% select(hhid, longitude=LON_DD_MOD, latitude = LAT_DD_MOD)
loc3_mappings <- unique(loc3_f)
```


# Fertilizer data
## Wave 1 (2010-2011)



fertilizer 
```{r}
fert_w1 <- read_csv('../lsms_data/nigeria/w1/sect11d_plantingw1.csv')
fert_w2 <- read_csv('../lsms_data/nigeria/w2/sect11d_plantingw2.csv')
fert_w3 <- read_csv('../lsms_data/nigeria/w3/secta11d_harvestw3.csv')
```


```{r}
fert1 <- fert_w1 %>% select(zone, state, hhid, fert=s11dq1, 
                      type_fert=s11dq14) %>% drop_na(fert)
fert2 <- fert_w2 %>% select(zone, state, hhid, fert=s11dq1, 
                      type_fert=s11dq15) %>% drop_na(fert)
fert3 <- fert_w3 %>% select(zone, state, hhid, fert=s11dq1, 
                      type_fert=s11dq15) %>% drop_na(fert)

fert1_joined <- inner_join(fert1, loc1_mappings)
fert1_joined

fert2_joined <- inner_join(fert2, loc2_mappings)
fert2_joined

fert3_joined <- inner_join(fert3, loc3_mappings)
fert3_joined
```

```{r}
w1_fert <- data.frame(country="nigeria", start_yr = 2010, end_yr = 2011, fert1_joined, stringsAsFactors = F) 
w2_fert <- data.frame(country="nigeria", start_yr = 2012, end_yr = 2013, fert2_joined, stringsAsFactors = F)
w3_fert <- data.frame(country="nigeria", start_yr = 2015, end_yr = 2016, fert3_joined, stringsAsFactors = F)
fert <- rbind(w1_fert, w2_fert, w3_fert)
fert[!complete.cases(fert$longitude, fert$latitude), ]
```

```{r}
# join with sf data

fert_sf <- st_as_sf(x=fert, coords=c("longitude", "latitude"), crs = "+proj=longlat +datum=WGS84 +nodefs")
fert_joined <- st_join(nga_sf, fert_sf, left=FALSE)
fert_joined
```


```{r}
fert_df <- fert_joined %>% select(country, start_yr, end_yr, NAME_2, hhid, fert, type_fert) %>% st_set_geometry(NULL)
rownames(fert_df) <- 1:nrow(fert_df)
fert_df
```


```{r}
# replace 2s with 1s in fert
recode <- function(x) ifelse(x == 2 | x == 0, 0, 1)
fert_df <- fert_df %>% mutate_at(c("fert"), recode)

# if no fert used, then set type_fert to 0
fert_df[(fert_df$fert == 0) & !is.na(fert_df$fert), c("type_fert")] <- 0

# if fert used but not specified, then put other (set to 4)
fert_df[(fert_df$fert == 1) & is.na(fert_df$type_fert), "type_fert"] <- 4
fert_df
```

```{r}
fert_df <- cbind(fert_df, dummy(fert_df$type_fert, sep='_'))
fert_df
```


```{r}
fert_df_dummies <- fert_df %>% rename(no_fert=fert_df_0, npk=fert_df_1, urea=fert_df_2, composite_manure=fert_df_3, other=fert_df_4)
fert_df_dummies <- fert_df_dummies %>% select(-c(type_fert, no_fert)) %>% mutate(organic_fert_dummy = composite_manure, inorganic_fert_dummy = as.numeric((npk+urea) > 0), fert_dummy = as.numeric((organic_fert_dummy + inorganic_fert_dummy) > 0)) 
fert_df_dummies 
```

```{r}
fert_df_grouped <- fert_df_dummies %>% group_by(country, start_yr, end_yr, NAME_2, hhid) %>% summarize_all(indicator) %>% drop_na()

fert_avg <- fert_df_grouped %>% select(-hhid) %>% group_by(country, start_yr, end_yr, NAME_2) %>% summarize_all(mean)

fert_avg$num_hh_fert <- (fert_df_grouped %>% tally())$n
fert_avg
```


# Pesticide/Herbicide

Note: wave 2 is missing sect11c2_plantingw2 -  will try to redownload.

```{r}
w1_pest <- read_csv('../lsms_data/nigeria/w1/sect11c_plantingw1.csv')
w1_pest

w3_pest <- read_csv('../lsms_data/nigeria/w3/secta11c2_harvestw3.csv')
w3_pest
```


```{r}
pest1 <- w1_pest %>% select(hhid, pest=s11cq1, herb=s11cq10) %>% drop_na()
pest3 <- w3_pest %>% select(hhid, pest=s11c2q1, herb=s11c2q10) %>% drop_na()

pest1_j <- inner_join(pest1, loc1_mappings)
pest3_j <- inner_join(pest3, loc3_mappings)
pest1_j
pest3_j
```

```{r}
w1_p <- data.frame(country="nigeria", start_yr = 2010, end_yr = 2011, pest1_j, stringsAsFactors = F) 
w3_p <- data.frame(country="nigeria", start_yr = 2015, end_yr = 2016, pest3_j, stringsAsFactors = F)
pest_c <- rbind(w1_p, w3_p)
pest_c
```

```{r}
pest_sf <- st_as_sf(x=pest_c, coords=c("longitude", "latitude"), crs = "+proj=longlat +datum=WGS84 +nodefs")
pest_joined <- st_join(nga_sf, pest_sf, left=FALSE)
pest_joined
```

```{r}
pest_df <- pest_joined %>% select(country, start_yr, end_yr, NAME_2, hhid, pest, herb) %>% st_set_geometry(NULL)
rownames(pest_df) <- 1:nrow(pest_df)
pest_df
```

```{r}
# set all 2s to 0
pest_df[pest_df$pest == 2, c("pest")] <- 0
pest_df[pest_df$herb == 2, c("herb")] <- 0

pest_grouped <- pest_df %>% group_by(country, start_yr, end_yr, NAME_2, hhid) %>% summarize_all(indicator) %>% drop_na()

pest_avg <- pest_grouped %>% select(-hhid) %>% group_by(country, start_yr, end_yr, NAME_2) %>% summarize_all(mean)
pest_avg$num_hh_phf <- (pest_grouped %>% tally())$n
pest_avg
```


```{r}
nga_lsms <- full_join(fert_avg, pest_avg)
nga_lsms
```

# GAHI prevalence

```{r}
africa <- read_csv("../GAHI/data/africa_data.csv")
nga <- africa %>% filter(country_title == "Nigeria") %>% select(publication_year, prevalence, number_examined, number_positive, longitude, latitude) %>% drop_na()
nga_gahi_sf <- st_as_sf(x=nga, coords=c("longitude", "latitude"), crs= "+proj=longlat +datum=WGS84 +nodefs")
#plot(st_geometry(sp), axes=TRUE)
#plot(africa_pt, pch=1, col="red", add=TRUE)
joined_gahi <- st_join(nga_sf, nga_gahi_sf, left=FALSE)
joined_gahi
```



```{r}
# recalculate average prevalence per level2 
nga_gahi <- joined_gahi %>% select(publication_year, number_examined, number_positive, NAME_2) %>% group_by(publication_year, NAME_2) %>% summarize(prevalence=sum(number_positive)/sum(number_examined), num_examined=sum(number_examined), num_positive=sum(number_positive))
nga_gahi 
```


```{r}
nga_gahi_lsms <- inner_join(nga_gahi, nga_lsms, by=c("publication_year" = "start_yr", "NAME_2" = "NAME_2")) %>% st_set_geometry(NULL)
nga_gahi_lsms
```

```{r}
nga_final <- nga_gahi_lsms %>% select(country, level2_name=NAME_2, gahi_lsms_start_yr=publication_year, lsms_end_yr=end_yr, prevalence, num_positive, num_examined, fert, npk, urea, composite_manure, other, organic_fert_dummy, inorganic_fert_dummy, fert_dummy, num_hh_fert, pest, herb, num_hh_phf)
nga_final
```

```{r, eval=FALSE}
write_csv(nga_final, "../results/nga_final.csv")
```



# DTA to CSV
```{r, eval=FALSE}
a <- read_dta('../lsms_data/nigeria/dta/sect11d_plantingw1.dta')
write_csv(a, '../lsms_data/nigeria/sect11d_plantingw1.csv')

a <- read_dta('../lsms_data/nigeria/dta/sect11d_plantingw2.dta')
write_csv(a, '../lsms_data/nigeria/sect11d_plantingw2.csv')

a <- read_dta('../lsms_data/nigeria/dta/sect11c_plantingw1.dta')
write_csv(a, '../lsms_data/nigeria/sect11c_plantingw1.csv')

a <- read_dta('../lsms_data/nigeria/dta/sect11c1_plantingw2.dta')
write_csv(a, '../lsms_data/nigeria/sect11c1_plantingw2.csv')
```

