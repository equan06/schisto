---
title: "Nigeria LSMS All"
author: Elliot Quan
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r}
library(sf)
library(readr)
library(dplyr)
library(tidyr)
library(dummies)
```


```{r}
# random functions: documentation is not 100% complete, will fix later.
# 
# auxiliary function for handling sums of NA vectors
# handles NA by returning NA if all are NA
sumNA <- function(x) {
  if (all(is.na(x))) {
    return(NA)
  } else {
    return(sum(x, na.rm=TRUE))
  }
}

# take a vector of inputs: if at least 1 input is 1, then return 1 else 0.
# handles NA by returning NA if all are NA
indicator <- function(x) {
  if (all(is.na(x))) {
    return(NA)
  } else if (sum(x, na.rm=TRUE) > 0) {
    return(1)
  } else {
    return(0)
  }
}

#' Converts a column of quantity data to kg based on unit coding provided
#' by units. 1 = kg, 2 = g, 3 = liter, 4 = centiliter. Does not mutate original df.
#'
#' @param quant quantity (character) 
#' @param units specifies units of quant (integer)
#' @param data (dataframe)
#'
#' @return converted quant vector
unit_conv <- function(quant, units) {
  return(case_when(
    units == 1 ~ quant,
    units == 2 ~ quant/1000,
    units == 3 ~ quant,
    units == 4 ~ quant/100
  ))
}

#' Same as above function, except coding 1 = liter, 2 = gram, 3 = kg, other = 0 (cannot convert units)
#' This also works for 1 = kg, 2 = gram, 3 = liter
unit_conv_pest <- function(quant, units) {
  return(case_when(
    units == 1 ~ quant,
    units == 2 ~ quant/1000,
    units == 3 ~ quant,
    is.numeric(units) ~ 0 
  ))
}

#' If x is 2 or 0, set to 0. This recodes an x column.
recode <- function(x) ifelse(x == 2 | x == 0, 0, 1)

#' this is mainly used for taking a y/n column x, and wanting to return 0 if x is 0 else y for each observation.
#' for example: if x = (0, 0, 1) and y = (NA, NA, 15), then we want to return (0, 0, 15).
handleNA <- function(x, y) ifelse(x == 0, 0, y)
```



# Description

This notebook generates a csv file where each record corresponds to a unique household > plot. Shapefiles are from GADM at the 2nd subdivision level.



# Shapefiles 

We are using level 2 GADM shapefiles (2nd level of subdivision). By default the datum is WGS84 (crs=4326). We will convert to mercator (crs=3857).

```{r}
nga_sf <- readRDS('../shapefiles/nga/GADM/gadm36_NGA_2_sf.rds')
nga_sf <- st_transform(nga_sf, crs=3857)
```

# Geovars (location)

```{r}
loc1 <- read_csv("../lsms_data/nigeria/w1/NGA_HouseholdGeovariables_Y1.csv")
loc1

loc2 <- read_csv("../lsms_data/nigeria/w2/NGA_HouseholdGeovars_Y2.csv")
loc2 

loc3 <- read_csv("../lsms_data/nigeria/w3/nga_householdgeovars_y3.csv")
loc3
```


```{r}
loc1_f <- loc1 %>% select(hhid, longitude=lon_dd_mod, latitude = lat_dd_mod)
loc1_mappings <- unique(loc1_f)

loc2_f <- loc2 %>% select(hhid, longitude=lon_dd_mod, latitude = lat_dd_mod)
loc2_mappings <- unique(loc2_f)

loc3_f <- loc3 %>% select(hhid, longitude=LON_DD_MOD, latitude = LAT_DD_MOD)
loc3_mappings <- unique(loc3_f)
```




# Fertilizer data

fertilizer data
```{r}
fert_w1 <- read_csv('../lsms_data/nigeria/w1/sect11d_plantingw1.csv')
fert_w2 <- read_csv('../lsms_data/nigeria/w2/sect11d_plantingw2.csv')
fert_w3 <- read_csv('../lsms_data/nigeria/w3/secta11d_harvestw3.csv')
```

area data - need to join by plotid.
```{r}
area_w1 <- read_csv('../lsms_data/nigeria/w1/sect11a1_plantingw1.csv')
area_w2 <- read_csv('../lsms_data/nigeria/w2/sect11a1_plantingw2.csv')
area_w3 <- read_csv('../lsms_data/nigeria/w3/sect11a1_plantingw3.csv')

area_w1 <- area_w1 %>% select(hhid, plotid, area = s11aq4d)
area_w2 <- area_w2 %>% select(hhid, plotid, area = s11aq4c)
area_w3 <- area_w3 %>% select(hhid, plotid, area = s11aq4c)

fert_w1 <- fert_w1 %>% inner_join(area_w1, by = c('hhid', 'plotid'))
fert_w2 <- fert_w2 %>% inner_join(area_w2, by = c('hhid', 'plotid'))
fert_w3 <- fert_w3 %>% inner_join(area_w3, by = c('hhid', 'plotid'))
```




```{r}
fert1 <- fert_w1 %>% select(zone, state, hhid, plotid, area, fert_yn = s11dq1, 
                          leftover_yn = s11dq2, leftover_type = s11dq3, leftover_quant = s11dq4, 
                          free_yn = s11dq6, free_type = s11dq7, free_quant = s11dq8,
                          bought1_yn = s11dq12, bought1_type = s11dq14, bought1_quant = s11dq15,
                          bought2_yn = s11dq23, bought2_type = s11dq25, bought2_quant = s11dq26) %>% drop_na(fert_yn)


fert2 <- fert_w2 %>% select(zone, state, hhid, plotid, area, fert_yn = s11dq1, 
                            leftover_yn = s11dq2, leftover_type = s11dq3, leftover_quant = s11dq4,
                            free_yn = s11dq6, free_type = s11dq7, free_quant = s11dq8,
                            bought1_yn = s11dq12, bought1_type = s11dq15, bought1_quant = s11dq16,
                            bought2_yn = s11dq24, bought2_type = s11dq27, bought2_quant = s11dq28) %>% drop_na(fert_yn)

# wave3 quantities are varied, so need to standardize all weights to kg using unit_conv
fert3 <- fert_w3 %>% select(zone, state, hhid, plotid, area, fert_yn = s11dq1, 
                            leftover_yn = s11dq2, leftover_type = s11dq3, leftover_quant = s11dq4a, leftover_quant_units = s11dq4b,
                            free_yn = sect11dq6, free_type = sect11dq7, free_quant = sect11dq8a, free_quant_units = sect11dq8b,
                            bought1_yn = s11dq12, bought1_type = s11dq15, bought1_quant = s11dq16a, bought1_quant_units = s11dq16b,
                            bought2_yn = s11dq24, bought2_type = s11dq27, bought2_quant = s11dq28a, bought2_quant_units = s11dq28b) %>% drop_na(fert_yn) %>% mutate(leftover_quant = unit_conv(leftover_quant, leftover_quant_units),
                          free_quant = unit_conv(free_quant, free_quant_units),
                          bought1_quant = unit_conv(bought1_quant, bought1_quant_units), 
                          bought2_quant = unit_conv(bought2_quant, bought2_quant_units)) %>% select(-contains('units'))

fert1_joined <- inner_join(fert1, loc1_mappings)
fert1_joined

fert2_joined <- inner_join(fert2, loc2_mappings)
fert2_joined

fert3_joined <- inner_join(fert3, loc3_mappings)
fert3_joined
```


```{r}
w1_fert <- data.frame(country="nigeria", start_yr = 2010, end_yr = 2011, fert1_joined, stringsAsFactors = F) 
w2_fert <- data.frame(country="nigeria", start_yr = 2012, end_yr = 2013, fert2_joined, stringsAsFactors = F)
w3_fert <- data.frame(country="nigeria", start_yr = 2015, end_yr = 2016, fert3_joined, stringsAsFactors = F)
fert <- rbind(w1_fert, w2_fert, w3_fert)
fert
```


# recoding data
```{r}
# for all y/n cols, change 2s to 0s

fert <- fert %>% mutate_at(c('fert_yn', 'leftover_yn', 'free_yn', 'bought1_yn', 'bought2_yn'), recode)

# if no fert used, then set the following cols to 0.

fert <- fert %>% mutate_at(c('leftover_yn', 'free_yn', 'bought1_yn', 'bought2_yn', 'leftover_type', 'free_type', 'bought1_type', 'bought2_type', 'leftover_quant', 'free_quant', 'bought1_quant', 'bought2_quant'), list(~handleNA(fert_yn, .)))


# same goes for the other categories of use: if none used, set both type and quant to 0.
fert <- fert %>% mutate_at(c('leftover_type', 'leftover_quant'), list(~handleNA(leftover_yn, .))) %>% 
  mutate_at(c('free_type', 'free_quant'), list(~handleNA(free_yn, .))) %>%
  mutate_at(c('bought1_type', 'bought1_quant'), list(~handleNA(bought1_yn, .))) %>%
  mutate_at(c('bought2_type', 'bought2_quant'), list(~handleNA(bought2_yn, .)))
fert
```


```{r}
# for each of leftover, free, bought1, bought2, check that the type matches the desired type. if so, then add that quantity to the sum and return the sum of the quants.
agg_quant <- function(type, df) {
  return(ifelse(df$leftover_type == type, df$leftover_quant, 0) + ifelse(df$free_type == type, df$free_quant, 0) + ifelse(df$bought1_type == type, df$bought1_quant, 0) + ifelse(df$bought2_type == type, df$bought2_quant, 0))
}

# return 1 if at least one of the 4 columns equals type, else 0.
yn_quant <- function(type, df) {
  return(as.numeric(((df$leftover_type == type) | (df$free_type == type) | (df$bought1_type == type) | (df$bought2_type == type))))
}


fert <- fert %>% mutate(npk_yn  = yn_quant(1, fert), urea_yn = yn_quant(2, fert), comp_manure_yn = yn_quant(3, fert), other_yn = yn_quant(4, fert))

fert <- fert %>% mutate(npk_quant = agg_quant(1, fert), urea_quant = agg_quant(2, fert), comp_manure_quant = agg_quant(3, fert), other_quant = agg_quant(4, fert), total_quant = npk_quant + urea_quant + comp_manure_quant + other_quant)

fert
```


```{r}
fert <- fert %>% rename(fert_rep_yn = fert_yn) %>% mutate(ofert_yn = comp_manure_yn, iofert_yn = as.numeric((npk_yn + urea_yn) > 0), fert_yn = as.numeric((ofert_yn + iofert_yn + other_yn) > 0)) 
fert
```

```{r}
fert_df <- fert %>% select(country, start_yr, end_yr, zone, state, hhid, plotid, area, fert_rep_yn, npk_yn, urea_yn, comp_manure_yn, other_yn, ofert_yn, iofert_yn, npk_quant, urea_quant, comp_manure_quant, other_quant, total_quant, longitude, latitude)
fert_df
```


# Pesticide data

Note: Wave2 is missing sect11c2_plantingw2, so until that can be found we will omit for now.

```{r}
w1_pest <- read_csv('../lsms_data/nigeria/w1/sect11c_plantingw1.csv')
w1_pest

w3_pest <- read_csv('../lsms_data/nigeria/w3/secta11c2_harvestw3.csv')
w3_pest
```



```{r}
pest1 <- w1_pest %>% select(hhid, plotid, pest_yn = s11cq1, pest_quant = s11cq2a, pest_quant_unit = s11cq2b, herb_yn = s11cq10, herb_quant = s11cq11a, herb_quant_unit = s11cq11b) %>% drop_na(pest_yn, herb_yn)
pest3 <- w3_pest %>% select(hhid, plotid, pest_yn =s11c2q1, pest_quant = s11c2q2a, pest_quant_unit = s11c2q2b, herb_yn = s11c2q10, herb_quant = s11c2q11a, herb_quant_unit = s11c2q11b) %>% drop_na(pest_yn, herb_yn)
pest1
pest3
```


```{r}
w1_p <- data.frame(country="nigeria", start_yr = 2010, end_yr = 2011, pest1, stringsAsFactors = F) 
w3_p <- data.frame(country="nigeria", start_yr = 2015, end_yr = 2016, pest3, stringsAsFactors = F)
pest_c <- rbind(w1_p, w3_p)
pest_c
```



```{r}
# for y/n cols, set 2 to 0
pest_c[pest_c$pest_yn == 2, c('pest_yn')] <- 0
pest_c[pest_c$herb_yn == 2, c('herb_yn')] <- 0

# if no pest used or no herb used, then set quant and type columns to 0.
pest_c <- pest_c %>% mutate_at(c('pest_quant', 'pest_quant_unit'), list(~handleNA(pest_yn, .))) %>% 
  mutate_at(c('herb_quant', 'herb_quant_unit'), list(~handleNA(herb_yn, .)))
pest_c

pest_df <- pest_c %>% mutate(pest_quant = unit_conv_pest(pest_quant, pest_quant_unit), herb_quant = unit_conv_pest(herb_quant, herb_quant_unit))
pest_df
```

# Merging Fertilizer + Pesticide

merge on country, start_yr, end_yr, hhid, plotid. To preserve the wave2 fertilizer data, we do a left join (since w2 pesticide data is missing).

```{r}
final_df <- fert_df %>% left_join(pest_df, by = c('country', 'start_yr', 'end_yr', 'hhid', 'plotid'))
final_df 
```

```{r}
final <- final_df %>% select(country, start_yr, end_yr, zone, state, hhid, plotid,  fert_rep_yn, npk_yn, urea_yn, comp_manure_yn, other_yn, ofert_yn, iofert_yn, pest_yn,  herb_yn,  quant_npk = npk_quant, quant_urea = urea_quant, quant_comp_manure = comp_manure_quant, quant_other = other_quant, quant_total = total_quant,  quant_pest = pest_quant, quant_herb = herb_quant, area, longitude, latitude) %>% mutate(quant_iofert = quant_npk + quant_urea) %>% select(-c('area', 'longitude', 'latitude'), c('area', 'longitude', 'latitude'))
final
```

```{r, eval=FALSE}
# write the df only 
write_csv(final, '../results/nga_lsms_full.csv')
```






